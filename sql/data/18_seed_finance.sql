-- ============================================================================
-- TDF DATA PLATFORM - SEED DATA: FINANCE
-- ============================================================================
-- Revenue (EUR 799.1M), CAPEX, Budgets, Accounting, EBITDA
-- Based on TDF 2024 Investor Presentation
-- ============================================================================

USE DATABASE TDF_DATA_PLATFORM;
USE SCHEMA FINANCE;

-- ============================================================================
-- REVENUE_BY_SEGMENT (TDF Revenue Structure - EUR 799.1M annualized)
-- ============================================================================

INSERT INTO REVENUE_BY_SEGMENT (
    REVENUE_ID, FISCAL_YEAR, FISCAL_MONTH, PERIOD_DATE,
    SEGMENT_LEVEL1, SEGMENT_LEVEL2,
    REVENUE_EUR, REVENUE_PRIOR_YEAR_EUR, REVENUE_YOY_GROWTH_PCT,
    REVENUE_TARGET_EUR, VARIANCE_TO_TARGET_EUR, VARIANCE_TO_TARGET_PCT,
    BU_ID
)
SELECT 
    'REV-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS REVENUE_ID,
    2025 AS FISCAL_YEAR,
    MONTH(cal.DATE_KEY) AS FISCAL_MONTH,
    cal.DATE_KEY AS PERIOD_DATE,
    seg.SEGMENT_LEVEL1,
    seg.SEGMENT_LEVEL2,
    seg.MONTHLY_REVENUE * (1 + UNIFORM(-0.05, 0.08, RANDOM())) AS REVENUE_EUR,
    seg.MONTHLY_REVENUE * 0.92 AS REVENUE_PRIOR_YEAR_EUR,
    UNIFORM(3, 12, RANDOM()) AS REVENUE_YOY_GROWTH_PCT,
    seg.MONTHLY_REVENUE AS REVENUE_TARGET_EUR,
    seg.MONTHLY_REVENUE * UNIFORM(-0.03, 0.05, RANDOM()) AS VARIANCE_TO_TARGET_EUR,
    UNIFORM(-3, 5, RANDOM()) AS VARIANCE_TO_TARGET_PCT,
    seg.BU_ID
FROM (
    SELECT DISTINCT DATE_TRUNC('MONTH', DATE_KEY) AS DATE_KEY 
    FROM TDF_DATA_PLATFORM.CORE.CALENDAR 
    WHERE DATE_KEY BETWEEN '2025-06-01' AND '2025-12-31'
) cal
CROSS JOIN (
    -- Revenue breakdown per investor presentation (monthly = annual / 12)
    SELECT 'BROADCAST' AS SEGMENT_LEVEL1, 'DTT' AS SEGMENT_LEVEL2, 157300000/12 AS MONTHLY_REVENUE, 'BU-DTT' AS BU_ID
    UNION ALL SELECT 'BROADCAST', 'RADIO', 116600000/12, 'BU-RADIO'
    UNION ALL SELECT 'TELECOMS', 'SITE_HOSTING', 457700000/12, 'BU-HOST'
    UNION ALL SELECT 'TELECOMS', 'OTHER_TELECOM', 26000000/12, 'BU-OTHR'
    UNION ALL SELECT 'CONNECTIVITY_EDGE', 'EDGE_CONNECT', 22600000/12, 'BU-EDC'
    UNION ALL SELECT 'CONNECTIVITY_EDGE', 'INDOOR', 10400000/12, 'BU-IND'
    UNION ALL SELECT 'CONNECTIVITY_EDGE', 'PMN', 1400000/12, 'BU-PMN'
    UNION ALL SELECT 'OTHER', 'OTHER', 7000000/12, 'BU-CORP'
) seg;

-- ============================================================================
-- REVENUE_BY_CLIENT (Operator breakdown)
-- ============================================================================

INSERT INTO REVENUE_BY_CLIENT (
    REVENUE_CLIENT_ID, FISCAL_YEAR, FISCAL_MONTH, PERIOD_DATE,
    OPERATOR_ID, REVENUE_EUR, REVENUE_PRIOR_YEAR_EUR, REVENUE_SHARE_PCT,
    SITE_HOSTING_REVENUE_EUR, ACTIVE_SITES, IS_TOP_10_CLIENT, CONCENTRATION_RISK
)
SELECT 
    'REVC-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS REVENUE_CLIENT_ID,
    2025 AS FISCAL_YEAR,
    MONTH(cal.DATE_KEY) AS FISCAL_MONTH,
    cal.DATE_KEY AS PERIOD_DATE,
    op.OPERATOR_ID,
    op.MONTHLY_SHARE * 483700000/12 * (1 + UNIFORM(-0.03, 0.05, RANDOM())) AS REVENUE_EUR,
    op.MONTHLY_SHARE * 483700000/12 * 0.92 AS REVENUE_PRIOR_YEAR_EUR,
    op.MONTHLY_SHARE * 100 AS REVENUE_SHARE_PCT,
    op.MONTHLY_SHARE * 457700000/12 AS SITE_HOSTING_REVENUE_EUR,
    ROUND(op.MONTHLY_SHARE * 8000) AS ACTIVE_SITES,
    TRUE AS IS_TOP_10_CLIENT,
    CASE WHEN op.MONTHLY_SHARE > 0.30 THEN 'HIGH' WHEN op.MONTHLY_SHARE > 0.20 THEN 'MEDIUM' ELSE 'LOW' END AS CONCENTRATION_RISK
FROM (
    SELECT DISTINCT DATE_TRUNC('MONTH', DATE_KEY) AS DATE_KEY 
    FROM TDF_DATA_PLATFORM.CORE.CALENDAR 
    WHERE DATE_KEY BETWEEN '2025-06-01' AND '2025-12-31'
) cal
CROSS JOIN (
    SELECT 'OP-ORANGE' AS OPERATOR_ID, 0.31 AS MONTHLY_SHARE
    UNION ALL SELECT 'OP-SFR', 0.27
    UNION ALL SELECT 'OP-BOUYGUES', 0.24
    UNION ALL SELECT 'OP-FREE', 0.18
) op;

-- ============================================================================
-- CAPEX_BUDGET (2025)
-- Growth ~61%, Maintenance ~8% of revenue per investor presentation
-- ============================================================================

INSERT INTO CAPEX_BUDGET (
    BUDGET_ID, FISCAL_YEAR, BUDGET_VERSION,
    CAPEX_CATEGORY, CAPEX_SUBCATEGORY, BUDGET_EUR,
    BU_ID, CATEGORY_PCT_OF_TOTAL, APPROVED_BY, APPROVAL_DATE
)
VALUES
    -- Growth CAPEX (~61% of total, ~180M)
    ('BUD-2025-001', 2025, 'INITIAL', 'GROWTH', 'NEW_TOWERS', 80000000, 'BU-HOST', 0.27, 'CFO', '2025-01-15'),
    ('BUD-2025-002', 2025, 'INITIAL', 'GROWTH', 'UPGRADES', 50000000, 'BU-HOST', 0.17, 'CFO', '2025-01-15'),
    ('BUD-2025-003', 2025, 'INITIAL', 'GROWTH', 'NEW_SITES', 30000000, 'BU-EDC', 0.10, 'CFO', '2025-01-15'),
    ('BUD-2025-004', 2025, 'INITIAL', 'GROWTH', 'PMN_EXPANSION', 20000000, 'BU-PMN', 0.07, 'CFO', '2025-01-15'),
    
    -- Maintenance CAPEX (~8% of revenue, ~64M)
    ('BUD-2025-005', 2025, 'INITIAL', 'MAINTENANCE', 'REPLACEMENTS', 35000000, 'BU-HOST', 0.12, 'CFO', '2025-01-15'),
    ('BUD-2025-006', 2025, 'INITIAL', 'MAINTENANCE', 'BROADCAST_MAINT', 20000000, 'BU-BC', 0.07, 'CFO', '2025-01-15'),
    ('BUD-2025-007', 2025, 'INITIAL', 'MAINTENANCE', 'POWER_SYSTEMS', 9000000, 'BU-HOST', 0.03, 'CFO', '2025-01-15'),
    
    -- Digitalization CAPEX
    ('BUD-2025-008', 2025, 'INITIAL', 'DIGITALIZATION', 'IT_SYSTEMS', 25000000, 'BU-CORP', 0.08, 'CFO', '2025-01-15'),
    ('BUD-2025-009', 2025, 'INITIAL', 'DIGITALIZATION', 'DIGITAL_TWIN', 15000000, 'BU-ENG', 0.05, 'CFO', '2025-01-15'),
    ('BUD-2025-010', 2025, 'INITIAL', 'DIGITALIZATION', 'NOC_UPGRADES', 10000000, 'BU-NOC', 0.03, 'CFO', '2025-01-15');

-- ============================================================================
-- CAPEX_ACTUALS (Monthly actuals June-December 2025)
-- ============================================================================

INSERT INTO CAPEX_ACTUALS (
    ACTUAL_ID, FISCAL_YEAR, FISCAL_MONTH, PERIOD_DATE,
    CAPEX_CATEGORY, CAPEX_SUBCATEGORY, ACTUAL_EUR, CUMULATIVE_YTD_EUR,
    BUDGET_ID, BUDGET_EUR, VARIANCE_EUR, VARIANCE_PCT, BU_ID
)
SELECT 
    'CAPX-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS ACTUAL_ID,
    2025 AS FISCAL_YEAR,
    MONTH(cal.DATE_KEY) AS FISCAL_MONTH,
    cal.DATE_KEY AS PERIOD_DATE,
    cb.CAPEX_CATEGORY,
    cb.CAPEX_SUBCATEGORY,
    cb.BUDGET_EUR / 12 * (1 + UNIFORM(-0.15, 0.10, RANDOM())) AS ACTUAL_EUR,
    cb.BUDGET_EUR / 12 * MONTH(cal.DATE_KEY) * 0.9 AS CUMULATIVE_YTD_EUR,
    cb.BUDGET_ID,
    cb.BUDGET_EUR / 12 AS BUDGET_EUR,
    cb.BUDGET_EUR / 12 * UNIFORM(-0.15, 0.10, RANDOM()) AS VARIANCE_EUR,
    UNIFORM(-15, 10, RANDOM()) AS VARIANCE_PCT,
    cb.BU_ID
FROM (
    SELECT DISTINCT DATE_TRUNC('MONTH', DATE_KEY) AS DATE_KEY 
    FROM TDF_DATA_PLATFORM.CORE.CALENDAR 
    WHERE DATE_KEY BETWEEN '2025-06-01' AND '2025-12-31'
) cal
CROSS JOIN CAPEX_BUDGET cb
WHERE cb.FISCAL_YEAR = 2025;

-- ============================================================================
-- EBITDA_METRICS (Target: 42-53% EBITDAaL margin)
-- ============================================================================

INSERT INTO EBITDA_METRICS (
    METRIC_ID, FISCAL_YEAR, FISCAL_MONTH, PERIOD_DATE,
    REVENUE_EUR, ENERGY_PASSTHROUGH_EUR, NET_REVENUE_EUR,
    OPEX_EUR, PERSONNEL_COST_EUR, ENERGY_COST_EUR, MAINTENANCE_COST_EUR, OTHER_OPEX_EUR,
    EBITDA_EUR, EBITDA_MARGIN_PCT,
    LEASE_COST_EUR, EBITDAAL_EUR, EBITDAAL_MARGIN_PCT,
    PRIOR_YEAR_EBITDAAL_EUR, YOY_GROWTH_PCT,
    BU_ID, TRAFFIC_LIGHT
)
SELECT 
    'EBITDA-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 5, '0') AS METRIC_ID,
    2025 AS FISCAL_YEAR,
    MONTH(cal.DATE_KEY) AS FISCAL_MONTH,
    cal.DATE_KEY AS PERIOD_DATE,
    799100000/12 * (1 + UNIFORM(-0.03, 0.05, RANDOM())) AS REVENUE_EUR,
    799100000/12 * 0.08 AS ENERGY_PASSTHROUGH_EUR,  -- ~8% pass-through
    799100000/12 * 0.92 AS NET_REVENUE_EUR,
    799100000/12 * 0.45 AS OPEX_EUR,
    799100000/12 * 0.20 AS PERSONNEL_COST_EUR,
    799100000/12 * 0.10 AS ENERGY_COST_EUR,
    799100000/12 * 0.08 AS MAINTENANCE_COST_EUR,
    799100000/12 * 0.07 AS OTHER_OPEX_EUR,
    799100000/12 * 0.55 AS EBITDA_EUR,
    55.0 + UNIFORM(-3, 3, RANDOM()) AS EBITDA_MARGIN_PCT,
    799100000/12 * 0.08 AS LEASE_COST_EUR,
    799100000/12 * 0.47 AS EBITDAAL_EUR,
    47.0 + UNIFORM(-5, 6, RANDOM()) AS EBITDAAL_MARGIN_PCT,  -- Target 42-53%
    799100000/12 * 0.44 AS PRIOR_YEAR_EBITDAAL_EUR,
    UNIFORM(5, 12, RANDOM()) AS YOY_GROWTH_PCT,
    'BU-CORP' AS BU_ID,
    CASE 
        WHEN 47.0 + UNIFORM(-5, 6, RANDOM()) >= 45 THEN 'GREEN'
        WHEN 47.0 + UNIFORM(-5, 6, RANDOM()) >= 40 THEN 'AMBER'
        ELSE 'RED'
    END AS TRAFFIC_LIGHT
FROM (
    SELECT DISTINCT DATE_TRUNC('MONTH', DATE_KEY) AS DATE_KEY 
    FROM TDF_DATA_PLATFORM.CORE.CALENDAR 
    WHERE DATE_KEY BETWEEN '2025-06-01' AND '2025-12-31'
) cal;

-- ============================================================================
-- ACCOUNTING_ENTRIES (Sample entries with audit trail)
-- ============================================================================

INSERT INTO ACCOUNTING_ENTRIES (
    ENTRY_ID, JOURNAL_ID, LINE_NUMBER,
    POSTING_DATE, FISCAL_YEAR, FISCAL_PERIOD,
    GL_ACCOUNT, GL_ACCOUNT_NAME, ACCOUNT_TYPE,
    DEBIT_EUR, CREDIT_EUR, COST_CENTER_ID, BU_ID,
    DESCRIPTION, DOCUMENT_TYPE, DOCUMENT_NUMBER,
    SOURCE_SYSTEM, SOURCE_MODULE, SOURCE_RECORD_ID,
    CREATED_BY, IS_POSTED, IS_ESG_RELEVANT
)
SELECT 
    'AE-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 8, '0') AS ENTRY_ID,
    'JNL-2025-' || LPAD(FLOOR(ROW_NUMBER() OVER (ORDER BY 1) / 2), 6, '0') AS JOURNAL_ID,
    MOD(ROW_NUMBER() OVER (ORDER BY 1), 2) + 1 AS LINE_NUMBER,
    DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01')::DATE AS POSTING_DATE,
    2025 AS FISCAL_YEAR,
    MONTH(DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01')) AS FISCAL_PERIOD,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 10)
        WHEN 0 THEN '411000' WHEN 1 THEN '401000' WHEN 2 THEN '606100'
        WHEN 3 THEN '613200' WHEN 4 THEN '641000' WHEN 5 THEN '681100'
        WHEN 6 THEN '701000' WHEN 7 THEN '706000' WHEN 8 THEN '512000'
        ELSE '445710'
    END AS GL_ACCOUNT,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 10)
        WHEN 0 THEN 'Clients' WHEN 1 THEN 'Fournisseurs' WHEN 2 THEN 'Énergie'
        WHEN 3 THEN 'Locations' WHEN 4 THEN 'Salaires' WHEN 5 THEN 'Amortissements'
        WHEN 6 THEN 'Ventes Hébergement' WHEN 7 THEN 'Ventes Services' WHEN 8 THEN 'Banque'
        ELSE 'TVA collectée'
    END AS GL_ACCOUNT_NAME,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 10)
        WHEN 0 THEN 'ASSET' WHEN 1 THEN 'LIABILITY' WHEN 2 THEN 'EXPENSE'
        WHEN 3 THEN 'EXPENSE' WHEN 4 THEN 'EXPENSE' WHEN 5 THEN 'EXPENSE'
        WHEN 6 THEN 'REVENUE' WHEN 7 THEN 'REVENUE' WHEN 8 THEN 'ASSET'
        ELSE 'LIABILITY'
    END AS ACCOUNT_TYPE,
    CASE WHEN MOD(ROW_NUMBER() OVER (ORDER BY 1), 2) = 0 THEN UNIFORM(1000, 500000, RANDOM()) ELSE 0 END AS DEBIT_EUR,
    CASE WHEN MOD(ROW_NUMBER() OVER (ORDER BY 1), 2) = 1 THEN UNIFORM(1000, 500000, RANDOM()) ELSE 0 END AS CREDIT_EUR,
    'CC-HOST' AS COST_CENTER_ID,
    'BU-HOST' AS BU_ID,
    'Accounting entry' AS DESCRIPTION,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 3) WHEN 0 THEN 'INVOICE' WHEN 1 THEN 'PAYMENT' ELSE 'JOURNAL' END AS DOCUMENT_TYPE,
    'DOC-2025-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS DOCUMENT_NUMBER,
    'TDF_ERP' AS SOURCE_SYSTEM,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 3) WHEN 0 THEN 'AP' WHEN 1 THEN 'AR' ELSE 'GL' END AS SOURCE_MODULE,
    'SRC-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 8, '0') AS SOURCE_RECORD_ID,
    'finance_user' AS CREATED_BY,
    TRUE AS IS_POSTED,
    CASE WHEN MOD(ROW_NUMBER() OVER (ORDER BY 1), 10) IN (2, 3) THEN TRUE ELSE FALSE END AS IS_ESG_RELEVANT
FROM TABLE(GENERATOR(ROWCOUNT => 85000));

-- ============================================================================
-- RENEWAL_FORECAST (Equipment replacement predictions)
-- ============================================================================

INSERT INTO RENEWAL_FORECAST (
    FORECAST_ID, EQUIPMENT_ID, SITE_ID, FORECAST_DATE,
    PREDICTED_REPLACEMENT_DATE, REPLACEMENT_YEAR, CONFIDENCE_PCT,
    REPLACEMENT_COST_EUR, INSTALLATION_COST_EUR, TOTAL_COST_EUR,
    AGE_YEARS, CONDITION_SCORE, FAILURE_RISK_SCORE,
    REPLACEMENT_PRIORITY, RECOMMENDED_ACTION,
    BUDGET_YEAR, IN_CURRENT_BUDGET
)
SELECT 
    'RENEW-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 7, '0') AS FORECAST_ID,
    e.EQUIPMENT_ID,
    e.SITE_ID,
    CURRENT_DATE() AS FORECAST_DATE,
    DATEADD(YEAR, UNIFORM(1, 5, RANDOM()), CURRENT_DATE()) AS PREDICTED_REPLACEMENT_DATE,
    2025 + UNIFORM(1, 5, RANDOM()) AS REPLACEMENT_YEAR,
    UNIFORM(60, 95, RANDOM()) AS CONFIDENCE_PCT,
    e.REPLACEMENT_COST_EUR,
    e.REPLACEMENT_COST_EUR * 0.15 AS INSTALLATION_COST_EUR,
    e.REPLACEMENT_COST_EUR * 1.15 AS TOTAL_COST_EUR,
    e.AGE_YEARS,
    es.CONDITION_SCORE,
    es.FAILURE_RISK_SCORE,
    CASE 
        WHEN es.FAILURE_RISK_SCORE >= 70 THEN 'CRITICAL'
        WHEN es.FAILURE_RISK_SCORE >= 50 THEN 'HIGH'
        WHEN es.FAILURE_RISK_SCORE >= 30 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS REPLACEMENT_PRIORITY,
    es.RECOMMENDED_ACTION,
    2025 + UNIFORM(0, 3, RANDOM()) AS BUDGET_YEAR,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 40 THEN TRUE ELSE FALSE END AS IN_CURRENT_BUDGET
FROM TDF_DATA_PLATFORM.INFRASTRUCTURE.EQUIPMENT e
LEFT JOIN TDF_DATA_PLATFORM.OPERATIONS.EQUIPMENT_STATUS es ON e.EQUIPMENT_ID = es.EQUIPMENT_ID
WHERE es.FAILURE_RISK_SCORE >= 30
LIMIT 20000;

SELECT 'FINANCE DATA SEEDED' AS STATUS,
       (SELECT COUNT(*) FROM REVENUE_BY_SEGMENT) AS REVENUE_SEG_COUNT,
       (SELECT COUNT(*) FROM REVENUE_BY_CLIENT) AS REVENUE_CLIENT_COUNT,
       (SELECT COUNT(*) FROM CAPEX_BUDGET) AS CAPEX_BUDGET_COUNT,
       (SELECT COUNT(*) FROM CAPEX_ACTUALS) AS CAPEX_ACTUALS_COUNT,
       (SELECT COUNT(*) FROM EBITDA_METRICS) AS EBITDA_COUNT,
       (SELECT COUNT(*) FROM ACCOUNTING_ENTRIES) AS ACCOUNTING_COUNT,
       (SELECT COUNT(*) FROM RENEWAL_FORECAST) AS RENEWAL_COUNT;

