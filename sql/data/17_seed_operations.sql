-- ============================================================================
-- TDF DATA PLATFORM - SEED DATA: OPERATIONS
-- ============================================================================
-- Work Orders, Maintenance Records, Equipment Status
-- Period: June 1, 2025 - December 19, 2025
-- ============================================================================

USE DATABASE TDF_DATA_PLATFORM;
USE SCHEMA OPERATIONS;

-- ============================================================================
-- WORK_ORDERS (~17,000 for the period)
-- ============================================================================

INSERT INTO WORK_ORDERS (
    WORK_ORDER_ID, WORK_ORDER_NUMBER, WORK_ORDER_TYPE, PRIORITY, CATEGORY,
    SITE_ID, REGION_ID, TITLE, DESCRIPTION, BU_ID,
    CREATED_DATE, SCHEDULED_START, SCHEDULED_END, DUE_DATE, STATUS,
    ESTIMATED_HOURS, ESTIMATED_COST_EUR, SLA_TARGET_HOURS
)
SELECT 
    'WO-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 7, '0') AS WORK_ORDER_ID,
    'WO-2025-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS WORK_ORDER_NUMBER,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 5)
        WHEN 0 THEN 'MAINTENANCE'
        WHEN 1 THEN 'MAINTENANCE'
        WHEN 2 THEN 'INSPECTION'
        WHEN 3 THEN 'REPAIR'
        ELSE 'INSTALLATION'
    END AS WORK_ORDER_TYPE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 5 THEN 'EMERGENCY'
        WHEN UNIFORM(0, 100, RANDOM()) < 25 THEN 'HIGH'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS PRIORITY,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 60 THEN 'PREVENTIVE' ELSE 'CORRECTIVE' END AS CATEGORY,
    s.SITE_ID,
    d.REGION_ID,
    'Work Order: ' || s.SITE_NAME AS TITLE,
    'Standard maintenance and inspection work' AS DESCRIPTION,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
        WHEN 0 THEN 'BU-HOST'
        WHEN 1 THEN 'BU-DTT'
        WHEN 2 THEN 'BU-RADIO'
        ELSE 'BU-NOC'
    END AS BU_ID,
    DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01')::DATE AS CREATED_DATE,
    DATEADD(DAY, UNIFORM(1, 14, RANDOM()), DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01'))::DATE AS SCHEDULED_START,
    DATEADD(DAY, UNIFORM(1, 7, RANDOM()), DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01'))::DATE AS SCHEDULED_END,
    DATEADD(DAY, UNIFORM(7, 30, RANDOM()), DATEADD(DAY, UNIFORM(0, 200, RANDOM()), '2025-06-01'))::DATE AS DUE_DATE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'COMPLETED'
        WHEN UNIFORM(0, 100, RANDOM()) < 85 THEN 'IN_PROGRESS'
        WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'ASSIGNED'
        ELSE 'OPEN'
    END AS STATUS,
    UNIFORM(2, 24, RANDOM()) AS ESTIMATED_HOURS,
    UNIFORM(500, 15000, RANDOM()) AS ESTIMATED_COST_EUR,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 5 THEN 4  -- Emergency
        WHEN UNIFORM(0, 100, RANDOM()) < 25 THEN 24  -- High
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 72  -- Medium
        ELSE 168  -- Low (1 week)
    END AS SLA_TARGET_HOURS
FROM TDF_DATA_PLATFORM.INFRASTRUCTURE.SITES s
LEFT JOIN TDF_DATA_PLATFORM.CORE.DEPARTMENTS d ON s.DEPARTMENT_ID = d.DEPARTMENT_ID
WHERE s.STATUS = 'ACTIVE'
ORDER BY RANDOM()
LIMIT 17000;

-- Update actual dates and costs for completed work orders
UPDATE WORK_ORDERS
SET 
    ACTUAL_START = SCHEDULED_START,
    ACTUAL_END = DATEADD(DAY, UNIFORM(1, 5, RANDOM()), SCHEDULED_START),
    ACTUAL_HOURS = ESTIMATED_HOURS * UNIFORM(0.8, 1.3, RANDOM()),
    ACTUAL_COST_EUR = ESTIMATED_COST_EUR * UNIFORM(0.85, 1.2, RANDOM()),
    SLA_MET = CASE WHEN UNIFORM(0, 100, RANDOM()) < 92 THEN TRUE ELSE FALSE END
WHERE STATUS = 'COMPLETED';

-- ============================================================================
-- MAINTENANCE_RECORDS (~12,000)
-- ============================================================================

INSERT INTO MAINTENANCE_RECORDS (
    MAINTENANCE_ID, WORK_ORDER_ID, EQUIPMENT_ID, SITE_ID,
    MAINTENANCE_TYPE, DESCRIPTION, ISSUE_FOUND, RESOLUTION,
    SCHEDULED_DATE, PERFORMED_DATE,
    TECHNICIAN_NAME, DURATION_HOURS, DOWNTIME_HOURS,
    PARTS_COST_EUR, LABOR_COST_EUR, TOTAL_COST_EUR,
    CONDITION_BEFORE, CONDITION_AFTER, NEXT_MAINTENANCE_DATE
)
SELECT 
    'MAINT-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 7, '0') AS MAINTENANCE_ID,
    wo.WORK_ORDER_ID,
    e.EQUIPMENT_ID,
    e.SITE_ID,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
        WHEN 0 THEN 'PREVENTIVE'
        WHEN 1 THEN 'PREVENTIVE'
        WHEN 2 THEN 'CORRECTIVE'
        ELSE 'PREDICTIVE'
    END AS MAINTENANCE_TYPE,
    'Equipment maintenance and inspection' AS DESCRIPTION,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 30 THEN 'Minor wear detected' ELSE NULL END AS ISSUE_FOUND,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 30 THEN 'Parts replaced as per schedule' ELSE 'No issues found' END AS RESOLUTION,
    wo.SCHEDULED_START AS SCHEDULED_DATE,
    COALESCE(wo.ACTUAL_END, wo.SCHEDULED_END) AS PERFORMED_DATE,
    'Technicien TDF' AS TECHNICIAN_NAME,
    UNIFORM(1, 8, RANDOM()) AS DURATION_HOURS,
    UNIFORM(0, 2, RANDOM()) AS DOWNTIME_HOURS,
    UNIFORM(0, 2000, RANDOM()) AS PARTS_COST_EUR,
    UNIFORM(100, 800, RANDOM()) AS LABOR_COST_EUR,
    UNIFORM(100, 2800, RANDOM()) AS TOTAL_COST_EUR,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'GOOD' ELSE 'FAIR' END AS CONDITION_BEFORE,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 85 THEN 'GOOD' ELSE 'FAIR' END AS CONDITION_AFTER,
    DATEADD(MONTH, UNIFORM(3, 12, RANDOM()), COALESCE(wo.ACTUAL_END, wo.SCHEDULED_END)) AS NEXT_MAINTENANCE_DATE
FROM WORK_ORDERS wo
CROSS JOIN (SELECT EQUIPMENT_ID, SITE_ID FROM TDF_DATA_PLATFORM.INFRASTRUCTURE.EQUIPMENT ORDER BY RANDOM() LIMIT 1) e
WHERE wo.STATUS = 'COMPLETED' AND wo.WORK_ORDER_TYPE = 'MAINTENANCE'
LIMIT 12000;

-- ============================================================================
-- EQUIPMENT_STATUS (Current status snapshot)
-- ============================================================================

INSERT INTO EQUIPMENT_STATUS (
    STATUS_ID, EQUIPMENT_ID, STATUS_DATE,
    OPERATIONAL_STATUS, CONDITION_SCORE, CONDITION_LABEL,
    FAILURE_RISK_SCORE, FAILURE_PROBABILITY_30D,
    PERFORMANCE_SCORE, UPTIME_PCT_30D,
    HAS_ACTIVE_ALERTS, ALERT_COUNT,
    DAYS_SINCE_LAST_MAINTENANCE, DAYS_UNTIL_NEXT_MAINTENANCE, MAINTENANCE_OVERDUE,
    REMAINING_LIFE_YEARS, RECOMMENDED_ACTION
)
SELECT 
    'EQST-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 7, '0') AS STATUS_ID,
    EQUIPMENT_ID,
    CURRENT_DATE() AS STATUS_DATE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 85 THEN 'OPERATIONAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'DEGRADED'
        WHEN UNIFORM(0, 100, RANDOM()) < 99 THEN 'MAINTENANCE'
        ELSE 'FAILED'
    END AS OPERATIONAL_STATUS,
    CONDITION_SCORE,
    CASE 
        WHEN CONDITION_SCORE >= 80 THEN 'EXCELLENT'
        WHEN CONDITION_SCORE >= 60 THEN 'GOOD'
        WHEN CONDITION_SCORE >= 40 THEN 'FAIR'
        WHEN CONDITION_SCORE >= 20 THEN 'POOR'
        ELSE 'CRITICAL'
    END AS CONDITION_LABEL,
    FAILURE_RISK_SCORE,
    FAILURE_RISK_SCORE / 100.0 * 0.3 AS FAILURE_PROBABILITY_30D,
    UNIFORM(70, 100, RANDOM()) AS PERFORMANCE_SCORE,
    UNIFORM(95, 100, RANDOM()) AS UPTIME_PCT_30D,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 10 THEN TRUE ELSE FALSE END AS HAS_ACTIVE_ALERTS,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 10 THEN UNIFORM(1, 5, RANDOM()) ELSE 0 END AS ALERT_COUNT,
    UNIFORM(10, 180, RANDOM()) AS DAYS_SINCE_LAST_MAINTENANCE,
    UNIFORM(-30, 180, RANDOM()) AS DAYS_UNTIL_NEXT_MAINTENANCE,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 8 THEN TRUE ELSE FALSE END AS MAINTENANCE_OVERDUE,
    DATEDIFF(YEAR, CURRENT_DATE(), EXPECTED_END_OF_LIFE) AS REMAINING_LIFE_YEARS,
    CASE 
        WHEN FAILURE_RISK_SCORE >= 80 THEN 'REPLACE_NOW'
        WHEN FAILURE_RISK_SCORE >= 60 THEN 'REPLACE_SOON'
        WHEN FAILURE_RISK_SCORE >= 40 THEN 'MAINTENANCE'
        WHEN FAILURE_RISK_SCORE >= 20 THEN 'MONITOR'
        ELSE 'NONE'
    END AS RECOMMENDED_ACTION
FROM TDF_DATA_PLATFORM.INFRASTRUCTURE.EQUIPMENT;

-- ============================================================================
-- RESOURCE_ALLOCATION
-- ============================================================================

INSERT INTO RESOURCE_ALLOCATION (
    ALLOCATION_ID, EMPLOYEE_ID, WORK_ORDER_ID,
    START_DATE, END_DATE, FTE_ALLOCATED, HOURS_ALLOCATED,
    ROLE_ON_ASSIGNMENT, IS_LEAD, STATUS, HOURS_WORKED
)
SELECT 
    'ALLOC-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 7, '0') AS ALLOCATION_ID,
    e.EMPLOYEE_ID,
    wo.WORK_ORDER_ID,
    wo.SCHEDULED_START AS START_DATE,
    COALESCE(wo.ACTUAL_END, wo.SCHEDULED_END) AS END_DATE,
    0.5 AS FTE_ALLOCATED,
    wo.ESTIMATED_HOURS AS HOURS_ALLOCATED,
    'Field Technician' AS ROLE_ON_ASSIGNMENT,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 20 THEN TRUE ELSE FALSE END AS IS_LEAD,
    CASE WHEN wo.STATUS = 'COMPLETED' THEN 'COMPLETED' ELSE 'ACTIVE' END AS STATUS,
    CASE WHEN wo.STATUS = 'COMPLETED' THEN wo.ACTUAL_HOURS ELSE NULL END AS HOURS_WORKED
FROM WORK_ORDERS wo
CROSS JOIN (SELECT EMPLOYEE_ID FROM TDF_DATA_PLATFORM.HR.EMPLOYEES WHERE IS_FIELD_WORKER = TRUE ORDER BY RANDOM() LIMIT 1) e
WHERE wo.STATUS IN ('COMPLETED', 'IN_PROGRESS', 'ASSIGNED')
LIMIT 15000;

-- ============================================================================
-- INCIDENTS
-- ============================================================================

INSERT INTO INCIDENTS (
    INCIDENT_ID, INCIDENT_NUMBER, INCIDENT_TYPE, SEVERITY,
    SITE_ID, TITLE, DESCRIPTION,
    SERVICES_AFFECTED, CUSTOMERS_AFFECTED,
    DETECTED_AT, ACKNOWLEDGED_AT, RESOLVED_AT, DURATION_MINUTES,
    STATUS, RESOLUTION_NOTES
)
SELECT 
    'INC-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS INCIDENT_ID,
    'INC-2025-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 5, '0') AS INCIDENT_NUMBER,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
        WHEN 0 THEN 'OUTAGE'
        WHEN 1 THEN 'DEGRADATION'
        WHEN 2 THEN 'DEGRADATION'
        ELSE 'WARNING'
    END AS INCIDENT_TYPE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 5 THEN 'CRITICAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 20 THEN 'MAJOR'
        WHEN UNIFORM(0, 100, RANDOM()) < 60 THEN 'MINOR'
        ELSE 'WARNING'
    END AS SEVERITY,
    s.SITE_ID,
    'Service incident at ' || s.SITE_NAME AS TITLE,
    'Incident detected and logged' AS DESCRIPTION,
    'Mobile Services' AS SERVICES_AFFECTED,
    UNIFORM(100, 50000, RANDOM()) AS CUSTOMERS_AFFECTED,
    DATEADD(HOUR, -UNIFORM(1, 4000, RANDOM()), CURRENT_TIMESTAMP()) AS DETECTED_AT,
    DATEADD(MINUTE, UNIFORM(5, 30, RANDOM()), DATEADD(HOUR, -UNIFORM(1, 4000, RANDOM()), CURRENT_TIMESTAMP())) AS ACKNOWLEDGED_AT,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 95 
         THEN DATEADD(MINUTE, UNIFORM(30, 480, RANDOM()), DATEADD(HOUR, -UNIFORM(1, 4000, RANDOM()), CURRENT_TIMESTAMP()))
         ELSE NULL 
    END AS RESOLVED_AT,
    UNIFORM(30, 480, RANDOM()) AS DURATION_MINUTES,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'RESOLVED' ELSE 'INVESTIGATING' END AS STATUS,
    'Issue identified and resolved' AS RESOLUTION_NOTES
FROM TDF_DATA_PLATFORM.INFRASTRUCTURE.SITES s
WHERE s.STATUS = 'ACTIVE'
ORDER BY RANDOM()
LIMIT 500;

SELECT 'OPERATIONS DATA SEEDED' AS STATUS,
       (SELECT COUNT(*) FROM WORK_ORDERS) AS WORK_ORDERS_COUNT,
       (SELECT COUNT(*) FROM MAINTENANCE_RECORDS) AS MAINTENANCE_COUNT,
       (SELECT COUNT(*) FROM EQUIPMENT_STATUS) AS EQUIPMENT_STATUS_COUNT,
       (SELECT COUNT(*) FROM RESOURCE_ALLOCATION) AS ALLOCATION_COUNT,
       (SELECT COUNT(*) FROM INCIDENTS) AS INCIDENTS_COUNT;

