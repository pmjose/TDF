-- ============================================================================
-- TDF DATA PLATFORM - SEED DATA: COMMERCIAL
-- ============================================================================
-- Demand Forecast, Projects, Contracts
-- Supports UC1: Resource & Capacity Planning
-- ============================================================================

USE ROLE SYSADMIN;
USE WAREHOUSE TDF_WH;
USE DATABASE TDF_DATA_PLATFORM;
USE SCHEMA COMMERCIAL;

-- ============================================================================
-- TRUNCATE ALL COMMERCIAL TABLES (Idempotent - safe to re-run)
-- ============================================================================

TRUNCATE TABLE IF EXISTS CONTRACTS;
TRUNCATE TABLE IF EXISTS PROJECTS;
TRUNCATE TABLE IF EXISTS DEMAND_FORECAST;

-- ============================================================================
-- DEMAND_FORECAST (18-month rolling forecast)
-- ============================================================================

INSERT INTO DEMAND_FORECAST (
    FORECAST_ID, FORECAST_DATE, TARGET_MONTH, HORIZON_MONTHS,
    BU_ID, REGION_ID, SERVICE_TYPE,
    DEMAND_FTE, DEMAND_HOURS, SKILL_CATEGORY_ID,
    REVENUE_FORECAST_EUR, COMMERCIAL_CONTRIBUTION_EUR,
    FORECAST_TYPE, CONFIDENCE_PCT,
    PREVIOUS_FORECAST_FTE, VARIANCE_FTE,
    FORECAST_VERSION, CREATED_BY
)
SELECT 
    'DF-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 6, '0') AS FORECAST_ID,
    '2025-06-01'::DATE AS FORECAST_DATE,
    target.TARGET_MONTH,
    DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) AS HORIZON_MONTHS,
    bu.BU_ID,
    r.REGION_ID,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
        WHEN 0 THEN 'SITE_HOSTING'
        WHEN 1 THEN 'BROADCAST'
        WHEN 2 THEN 'INDOOR'
        ELSE 'EDGE'
    END AS SERVICE_TYPE,
    -- Demand FTE (increases over time with business growth)
    UNIFORM(5, 20, RANDOM()) * (1 + DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) * 0.02) AS DEMAND_FTE,
    UNIFORM(800, 3200, RANDOM()) AS DEMAND_HOURS,
    sc.SKILL_CATEGORY_ID,
    -- Revenue forecast based on TDF segments
    UNIFORM(500000, 5000000, RANDOM()) AS REVENUE_FORECAST_EUR,
    UNIFORM(200000, 2000000, RANDOM()) AS COMMERCIAL_CONTRIBUTION_EUR,
    CASE 
        WHEN DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) <= 3 THEN 'COMMITTED'
        WHEN DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) <= 9 THEN 'PIPELINE'
        ELSE 'SPECULATIVE'
    END AS FORECAST_TYPE,
    CASE 
        WHEN DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) <= 3 THEN UNIFORM(85, 95, RANDOM())
        WHEN DATEDIFF(MONTH, '2025-06-01', target.TARGET_MONTH) <= 9 THEN UNIFORM(60, 85, RANDOM())
        ELSE UNIFORM(30, 60, RANDOM())
    END AS CONFIDENCE_PCT,
    UNIFORM(5, 18, RANDOM()) AS PREVIOUS_FORECAST_FTE,
    UNIFORM(-3, 5, RANDOM()) AS VARIANCE_FTE,
    1 AS FORECAST_VERSION,
    'planning_team' AS CREATED_BY
FROM (
    -- Generate 18 months of forecast: June 2025 to December 2026
    SELECT DATEADD(MONTH, seq4(), '2025-06-01')::DATE AS TARGET_MONTH
    FROM TABLE(GENERATOR(ROWCOUNT => 19))
) target
CROSS JOIN (SELECT * FROM CORE.BUSINESS_UNITS WHERE BU_TYPE != 'CORPORATE' LIMIT 5) bu
CROSS JOIN (SELECT * FROM CORE.REGIONS LIMIT 5) r
CROSS JOIN (SELECT * FROM CORE.SKILL_CATEGORIES LIMIT 3) sc;

-- ============================================================================
-- PROJECTS (~500 Active/Planned Projects)
-- ============================================================================

INSERT INTO PROJECTS (
    PROJECT_ID, PROJECT_CODE, PROJECT_NAME,
    PROJECT_TYPE, PRIORITY, BU_ID,
    OPERATOR_ID, IS_INTERNAL, REGION_ID,
    PLANNED_START_DATE, PLANNED_END_DATE, ACTUAL_START_DATE,
    STATUS, PHASE, PCT_COMPLETE,
    ESTIMATED_FTE, ESTIMATED_HOURS, ACTUAL_HOURS,
    BUDGET_EUR, ACTUAL_COST_EUR, BUDGET_VARIANCE_EUR,
    EXPECTED_REVENUE_EUR, RISK_LEVEL
)
SELECT 
    'PRJ-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 5, '0') AS PROJECT_ID,
    'TDF-PRJ-2025-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 4, '0') AS PROJECT_CODE,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 8)
        WHEN 0 THEN '5G Site Upgrade ' || r.REGION_NAME
        WHEN 1 THEN 'New Tower Installation ' || r.REGION_NAME
        WHEN 2 THEN 'DTT Transmitter Replacement ' || r.REGION_NAME
        WHEN 3 THEN 'Indoor DAS Deployment ' || r.REGION_NAME
        WHEN 4 THEN 'Edge DC Expansion ' || r.REGION_NAME
        WHEN 5 THEN 'Power System Upgrade ' || r.REGION_NAME
        WHEN 6 THEN 'Site Maintenance Program ' || r.REGION_NAME
        ELSE 'Network Modernization ' || r.REGION_NAME
    END AS PROJECT_NAME,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 5)
        WHEN 0 THEN 'NEW_SITE'
        WHEN 1 THEN 'UPGRADE'
        WHEN 2 THEN 'MAINTENANCE'
        WHEN 3 THEN 'ROLLOUT'
        ELSE 'UPGRADE'
    END AS PROJECT_TYPE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 10 THEN 'CRITICAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 30 THEN 'HIGH'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS PRIORITY,
    bu.BU_ID,
    op.OPERATOR_ID,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 20 THEN TRUE ELSE FALSE END AS IS_INTERNAL,
    r.REGION_ID,
    DATEADD(DAY, UNIFORM(-100, 100, RANDOM()), '2025-06-01')::DATE AS PLANNED_START_DATE,
    DATEADD(DAY, UNIFORM(30, 180, RANDOM()), DATEADD(DAY, UNIFORM(-100, 100, RANDOM()), '2025-06-01'))::DATE AS PLANNED_END_DATE,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN DATEADD(DAY, UNIFORM(-100, 100, RANDOM()), '2025-06-01')::DATE ELSE NULL END AS ACTUAL_START_DATE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 40 THEN 'COMPLETED'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'IN_PROGRESS'
        WHEN UNIFORM(0, 100, RANDOM()) < 85 THEN 'APPROVED'
        ELSE 'DRAFT'
    END AS STATUS,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 40 THEN 'CLOSING'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'EXECUTION'
        WHEN UNIFORM(0, 100, RANDOM()) < 90 THEN 'PLANNING'
        ELSE 'INITIATION'
    END AS PHASE,
    UNIFORM(0, 100, RANDOM()) AS PCT_COMPLETE,
    UNIFORM(2, 20, RANDOM()) AS ESTIMATED_FTE,
    UNIFORM(500, 5000, RANDOM()) AS ESTIMATED_HOURS,
    UNIFORM(0, 4500, RANDOM()) AS ACTUAL_HOURS,
    UNIFORM(50000, 2000000, RANDOM()) AS BUDGET_EUR,
    UNIFORM(40000, 1800000, RANDOM()) AS ACTUAL_COST_EUR,
    UNIFORM(-200000, 100000, RANDOM()) AS BUDGET_VARIANCE_EUR,
    UNIFORM(100000, 5000000, RANDOM()) AS EXPECTED_REVENUE_EUR,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 10 THEN 'CRITICAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 30 THEN 'HIGH'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS RISK_LEVEL
FROM (SELECT 1 FROM TABLE(GENERATOR(ROWCOUNT => 500))) g
CROSS JOIN (SELECT * FROM CORE.BUSINESS_UNITS WHERE BU_TYPE != 'CORPORATE' ORDER BY RANDOM() LIMIT 1) bu
CROSS JOIN (SELECT * FROM CORE.REGIONS ORDER BY RANDOM() LIMIT 1) r
CROSS JOIN (SELECT * FROM CORE.OPERATORS WHERE OPERATOR_TYPE = 'MNO' ORDER BY RANDOM() LIMIT 1) op;

-- ============================================================================
-- CONTRACTS (~200 Active Contracts)
-- ============================================================================

INSERT INTO CONTRACTS (
    CONTRACT_ID, CONTRACT_NUMBER, CONTRACT_NAME,
    OPERATOR_ID, BU_ID, CONTRACT_TYPE, SERVICE_TYPE,
    START_DATE, END_DATE, AUTO_RENEWAL, NOTICE_PERIOD_DAYS,
    ANNUAL_VALUE_EUR, TOTAL_CONTRACT_VALUE_EUR, PAYMENT_TERMS_DAYS,
    IS_INDEXED, INDEX_TYPE, STATUS
)
SELECT 
    'CTR-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 5, '0') AS CONTRACT_ID,
    'TDF-CTR-' || op.OPERATOR_CODE || '-' || LPAD(ROW_NUMBER() OVER (ORDER BY 1), 4, '0') AS CONTRACT_NUMBER,
    op.OPERATOR_NAME || ' - ' || 
        CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
            WHEN 0 THEN 'Master Hosting Agreement'
            WHEN 1 THEN 'Site Lease Contract'
            WHEN 2 THEN 'Service Agreement'
            ELSE 'Maintenance Contract'
        END AS CONTRACT_NAME,
    op.OPERATOR_ID,
    bu.BU_ID,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 4)
        WHEN 0 THEN 'MASTER_AGREEMENT'
        WHEN 1 THEN 'SITE_LEASE'
        WHEN 2 THEN 'SERVICE'
        ELSE 'MAINTENANCE'
    END AS CONTRACT_TYPE,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY 1), 3)
        WHEN 0 THEN 'SITE_HOSTING'
        WHEN 1 THEN 'BROADCAST'
        ELSE 'CONNECTIVITY'
    END AS SERVICE_TYPE,
    DATEADD(YEAR, -UNIFORM(1, 10, RANDOM()), CURRENT_DATE())::DATE AS START_DATE,
    DATEADD(YEAR, UNIFORM(3, 15, RANDOM()), CURRENT_DATE())::DATE AS END_DATE,
    TRUE AS AUTO_RENEWAL,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 80 THEN 180 ELSE 365 END AS NOTICE_PERIOD_DAYS,
    UNIFORM(100000, 10000000, RANDOM()) AS ANNUAL_VALUE_EUR,
    UNIFORM(500000, 100000000, RANDOM()) AS TOTAL_CONTRACT_VALUE_EUR,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 30 ELSE 60 END AS PAYMENT_TERMS_DAYS,
    TRUE AS IS_INDEXED,  -- >90% of TDF contracts are indexed
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 60 THEN 'ILAT' ELSE 'CPI' END AS INDEX_TYPE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 85 THEN 'ACTIVE'
        WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'EXPIRING'
        ELSE 'EXPIRED'
    END AS STATUS
FROM (SELECT 1 FROM TABLE(GENERATOR(ROWCOUNT => 200))) g
CROSS JOIN (SELECT * FROM CORE.OPERATORS ORDER BY RANDOM() LIMIT 1) op
CROSS JOIN (SELECT * FROM CORE.BUSINESS_UNITS WHERE BU_TYPE != 'CORPORATE' ORDER BY RANDOM() LIMIT 1) bu;

SELECT 'COMMERCIAL DATA SEEDED' AS STATUS,
       (SELECT COUNT(*) FROM DEMAND_FORECAST) AS DEMAND_FORECAST_COUNT,
       (SELECT COUNT(*) FROM PROJECTS) AS PROJECTS_COUNT,
       (SELECT COUNT(*) FROM CONTRACTS) AS CONTRACTS_COUNT;

