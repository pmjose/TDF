-- ============================================================================
-- TDF DATA PLATFORM - SEED DATA: INFRASTRUCTURE
-- ============================================================================
-- 8,785 Sites, 7,877 Towers, Equipment, Antennas, Client Installations
-- Realistic distribution across French regions
-- ============================================================================

USE ROLE SYSADMIN;
USE WAREHOUSE TDF_WH;
USE DATABASE TDF_DATA_PLATFORM;
USE SCHEMA INFRASTRUCTURE;

-- ============================================================================
-- TRUNCATE ALL TABLES (Idempotent - safe to re-run)
-- ============================================================================

TRUNCATE TABLE IF EXISTS POINTS_OF_SERVICE;
TRUNCATE TABLE IF EXISTS FIBRE_NETWORK;
TRUNCATE TABLE IF EXISTS CLIENT_INSTALLATIONS;
TRUNCATE TABLE IF EXISTS BROADCAST_TRANSMITTERS;
TRUNCATE TABLE IF EXISTS ANTENNAS;
TRUNCATE TABLE IF EXISTS EQUIPMENT;
TRUNCATE TABLE IF EXISTS DATA_CENTERS;
TRUNCATE TABLE IF EXISTS INDOOR_SITES;
TRUNCATE TABLE IF EXISTS ROOFTOPS;
TRUNCATE TABLE IF EXISTS TOWERS;
TRUNCATE TABLE IF EXISTS SITES;

-- ============================================================================
-- SITES (8,785 Active Sites)
-- Distribution based on population density and TDF investor presentation
-- ============================================================================

-- Generate sites using Snowflake's data generation capabilities
INSERT INTO SITES (
    SITE_ID, SITE_CODE, SITE_NAME, SITE_TYPE, STATUS,
    DEPARTMENT_ID, ADDRESS, POSTAL_CODE, CITY, LATITUDE, LONGITUDE, ALTITUDE_M,
    LAND_OWNERSHIP, LEASE_START_DATE, LEASE_END_DATE, LEASE_ANNUAL_COST_EUR,
    COMMISSIONING_DATE, MAX_TENANTS, CURRENT_TENANTS, POWER_CAPACITY_KW,
    ANNUAL_REVENUE_EUR, ANNUAL_OPEX_EUR, ASSET_VALUE_EUR,
    RISK_SCORE, DIGITAL_TWIN_STATUS
)
SELECT 
    'SITE-' || LPAD(SEQ4() + 1, 6, '0') AS SITE_ID,
    'TDF-' || 
        CASE 
            WHEN MOD(SEQ4(), 5) = 0 THEN 'TWR'
            WHEN MOD(SEQ4(), 5) = 1 THEN 'TWR'
            WHEN MOD(SEQ4(), 5) = 2 THEN 'TWR'
            WHEN MOD(SEQ4(), 5) = 3 THEN 'RTF'
            ELSE 'IND'
        END || '-' || LPAD(SEQ4() + 1, 5, '0') AS SITE_CODE,
    CASE 
        WHEN MOD(SEQ4(), 5) IN (0,1,2) THEN 'Tour TDF ' || d.DEPARTMENT_NAME || ' ' || (SEQ4() % 100 + 1)
        WHEN MOD(SEQ4(), 5) = 3 THEN 'Toiture ' || d.PREFECTURE || ' ' || (SEQ4() % 50 + 1)
        ELSE 'DAS ' || d.PREFECTURE || ' ' || (SEQ4() % 30 + 1)
    END AS SITE_NAME,
    CASE 
        WHEN MOD(SEQ4(), 5) IN (0,1,2) THEN 'TOWER'
        WHEN MOD(SEQ4(), 5) = 3 THEN 'ROOFTOP'
        ELSE 'INDOOR'
    END AS SITE_TYPE,
    CASE WHEN UNIFORM(0, 100, RANDOM()) > 2 THEN 'ACTIVE' ELSE 'PLANNED' END AS STATUS,
    d.DEPARTMENT_ID,
    (SEQ4() % 999 + 1) || ' Rue de la République' AS ADDRESS,
    SUBSTRING(d.DEPARTMENT_CODE, 1, 2) || LPAD((SEQ4() % 900 + 100)::VARCHAR, 3, '0') AS POSTAL_CODE,
    d.PREFECTURE AS CITY,
    d.LATITUDE + (UNIFORM(-0.5, 0.5, RANDOM())) AS LATITUDE,
    d.LONGITUDE + (UNIFORM(-0.5, 0.5, RANDOM())) AS LONGITUDE,
    UNIFORM(10, 1500, RANDOM()) AS ALTITUDE_M,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 38 THEN 'OWNED'  -- 38% owned per investor presentation
        ELSE 'LEASED'
    END AS LAND_OWNERSHIP,
    DATEADD(YEAR, -UNIFORM(5, 30, RANDOM()), CURRENT_DATE()) AS LEASE_START_DATE,
    DATEADD(YEAR, UNIFORM(5, 50, RANDOM()), CURRENT_DATE()) AS LEASE_END_DATE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 38 THEN 0
        ELSE UNIFORM(5000, 25000, RANDOM())
    END AS LEASE_ANNUAL_COST_EUR,
    DATEADD(YEAR, -UNIFORM(1, 25, RANDOM()), CURRENT_DATE()) AS COMMISSIONING_DATE,
    CASE 
        WHEN MOD(SEQ4(), 5) IN (0,1,2) THEN UNIFORM(3, 6, RANDOM())
        ELSE UNIFORM(2, 4, RANDOM())
    END AS MAX_TENANTS,
    CASE 
        WHEN MOD(SEQ4(), 5) IN (0,1,2) THEN ROUND(UNIFORM(1, 6, RANDOM()) * 0.6)  -- ~3.9x colocation for towers
        ELSE ROUND(UNIFORM(1, 4, RANDOM()) * 0.5)
    END AS CURRENT_TENANTS,
    UNIFORM(10, 100, RANDOM()) AS POWER_CAPACITY_KW,
    UNIFORM(30000, 150000, RANDOM()) AS ANNUAL_REVENUE_EUR,
    UNIFORM(8000, 40000, RANDOM()) AS ANNUAL_OPEX_EUR,
    UNIFORM(100000, 2000000, RANDOM()) AS ASSET_VALUE_EUR,
    UNIFORM(5, 60, RANDOM()) AS RISK_SCORE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 92 THEN 'SYNCED'
        WHEN UNIFORM(0, 100, RANDOM()) < 97 THEN 'PENDING'
        ELSE 'DISCREPANCY'
    END AS DIGITAL_TWIN_STATUS
FROM 
    (
        -- Distribute 8785 sites across departments weighted by population
        -- Higher population = more sites
        SELECT 
            ROW_NUMBER() OVER (ORDER BY RANDOM()) as site_seq,
            d.*
        FROM (
            -- Repeat each department proportional to its population share
            SELECT dep.*, gen.seq as gen_seq
            FROM TDF_DATA_PLATFORM.CORE.DEPARTMENTS dep
            CROSS JOIN (
                SELECT SEQ4() as seq FROM TABLE(GENERATOR(ROWCOUNT => 200))
            ) gen
            WHERE gen.seq <= GREATEST(10, ROUND(dep.POPULATION / 670000.0 * 100))
            -- ~670K avg population per dept, gives ~100 base * 96 deps = ~9600 rows
        ) d
        ORDER BY RANDOM()
    ) d
WHERE d.site_seq <= 8785;

-- Calculate COLOCATION_RATE (was removed as computed column - Snowflake doesn't support GENERATED ALWAYS AS)
UPDATE SITES
SET COLOCATION_RATE = CURRENT_TENANTS / NULLIF(MAX_TENANTS, 0)
WHERE MAX_TENANTS > 0;

-- Update site distribution to match regional populations (weighted insert)
-- Île-de-France gets more sites (15%), etc.

-- ============================================================================
-- TOWERS (7,877 Towers based on investor presentation)
-- ============================================================================

INSERT INTO TOWERS (
    TOWER_ID, SITE_ID, TOWER_CODE, TOWER_NAME,
    TOWER_TYPE, HEIGHT_M, BASE_WIDTH_M, WEIGHT_KG, MAX_ANTENNA_LOAD_KG,
    MANUFACTURER, CONSTRUCTION_DATE, INSTALLATION_DATE, STRUCTURAL_CONDITION,
    AVAILABLE_POSITIONS, OCCUPIED_POSITIONS,
    EXPECTED_END_OF_LIFE, LIFECYCLE_STATUS,
    ORIGINAL_COST_EUR, CURRENT_BOOK_VALUE_EUR, REPLACEMENT_COST_EUR
)
SELECT 
    'TWR-' || LPAD(ROW_NUMBER() OVER (ORDER BY SITE_ID), 6, '0') AS TOWER_ID,
    SITE_ID,
    'TWR-' || SITE_CODE AS TOWER_CODE,
    SITE_NAME AS TOWER_NAME,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'LATTICE'
        WHEN UNIFORM(0, 100, RANDOM()) < 90 THEN 'MONOPOLE'
        ELSE 'GUYED'
    END AS TOWER_TYPE,
    UNIFORM(25, 120, RANDOM()) AS HEIGHT_M,
    UNIFORM(3, 8, RANDOM()) AS BASE_WIDTH_M,
    UNIFORM(5000, 50000, RANDOM()) AS WEIGHT_KG,
    UNIFORM(500, 2000, RANDOM()) AS MAX_ANTENNA_LOAD_KG,
    'TDF Toulouse Factory' AS MANUFACTURER,
    DATEADD(YEAR, -UNIFORM(5, 40, RANDOM()), CURRENT_DATE()) AS CONSTRUCTION_DATE,
    COMMISSIONING_DATE AS INSTALLATION_DATE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 30 THEN 'EXCELLENT'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'GOOD'
        WHEN UNIFORM(0, 100, RANDOM()) < 90 THEN 'FAIR'
        ELSE 'POOR'
    END AS STRUCTURAL_CONDITION,
    MAX_TENANTS AS AVAILABLE_POSITIONS,
    CURRENT_TENANTS AS OCCUPIED_POSITIONS,
    DATEADD(YEAR, UNIFORM(5, 30, RANDOM()), CURRENT_DATE()) AS EXPECTED_END_OF_LIFE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 20 THEN 'NEW'
        WHEN UNIFORM(0, 100, RANDOM()) < 80 THEN 'OPERATIONAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'AGING'
        ELSE 'END_OF_LIFE'
    END AS LIFECYCLE_STATUS,
    UNIFORM(150000, 800000, RANDOM()) AS ORIGINAL_COST_EUR,
    UNIFORM(50000, 400000, RANDOM()) AS CURRENT_BOOK_VALUE_EUR,
    UNIFORM(200000, 1000000, RANDOM()) AS REPLACEMENT_COST_EUR
FROM SITES
WHERE SITE_TYPE = 'TOWER'
LIMIT 7877;

-- ============================================================================
-- DATA_CENTERS (102 Edge + 4 Regional)
-- ============================================================================

-- Regional Data Centers
INSERT INTO DATA_CENTERS (DC_ID, SITE_ID, DC_CODE, DC_NAME, DC_TYPE, DC_TIER, TOTAL_RACK_CAPACITY, USED_RACKS, TOTAL_POWER_KW, AVAILABLE_POWER_KW, PUE_RATIO, CITY)
SELECT 
    'DC-REG-' || ROW_NUMBER() OVER (ORDER BY city_name) AS DC_ID,
    SITE_ID,
    'DC-REG-' || city_name AS DC_CODE,
    'TDF Regional DC ' || city_name AS DC_NAME,
    'REGIONAL' AS DC_TYPE,
    'TIER3' AS DC_TIER,
    200 AS TOTAL_RACK_CAPACITY,
    UNIFORM(120, 180, RANDOM()) AS USED_RACKS,
    2000 AS TOTAL_POWER_KW,
    UNIFORM(200, 600, RANDOM()) AS AVAILABLE_POWER_KW,
    UNIFORM(1.3, 1.6, RANDOM()) AS PUE_RATIO,
    city_name AS CITY
FROM (
    SELECT 'Bordeaux' AS city_name, (SELECT SITE_ID FROM SITES WHERE STATUS = 'ACTIVE' LIMIT 1) AS SITE_ID
    UNION ALL SELECT 'Lille', (SELECT SITE_ID FROM SITES WHERE STATUS = 'ACTIVE' LIMIT 1 OFFSET 1)
    UNION ALL SELECT 'Marseille', (SELECT SITE_ID FROM SITES WHERE STATUS = 'ACTIVE' LIMIT 1 OFFSET 2)
    UNION ALL SELECT 'Rennes', (SELECT SITE_ID FROM SITES WHERE STATUS = 'ACTIVE' LIMIT 1 OFFSET 3)
);

-- Edge Data Centers (102)
INSERT INTO DATA_CENTERS (DC_ID, SITE_ID, DC_CODE, DC_NAME, DC_TYPE, DC_TIER, TOTAL_RACK_CAPACITY, USED_RACKS, TOTAL_POWER_KW, AVAILABLE_POWER_KW, PUE_RATIO)
SELECT 
    'DC-EDGE-' || LPAD(ROW_NUMBER() OVER (ORDER BY SITE_ID), 3, '0') AS DC_ID,
    SITE_ID,
    'DC-EDGE-' || LPAD(ROW_NUMBER() OVER (ORDER BY SITE_ID), 3, '0') AS DC_CODE,
    'TDF Edge DC ' || ROW_NUMBER() OVER (ORDER BY SITE_ID) AS DC_NAME,
    'EDGE' AS DC_TYPE,
    'TIER2' AS DC_TIER,
    UNIFORM(10, 30, RANDOM()) AS TOTAL_RACK_CAPACITY,
    UNIFORM(5, 25, RANDOM()) AS USED_RACKS,
    UNIFORM(50, 200, RANDOM()) AS TOTAL_POWER_KW,
    UNIFORM(10, 100, RANDOM()) AS AVAILABLE_POWER_KW,
    UNIFORM(1.4, 1.8, RANDOM()) AS PUE_RATIO
FROM SITES
WHERE STATUS = 'ACTIVE'
LIMIT 102;

-- ============================================================================
-- CLIENT_INSTALLATIONS (~20,000 - Multiple operators per site)
-- ============================================================================

INSERT INTO CLIENT_INSTALLATIONS (
    INSTALLATION_ID, SITE_ID, OPERATOR_ID,
    CONTRACT_NUMBER, CONTRACT_START_DATE, CONTRACT_END_DATE, CONTRACT_TYPE,
    TECHNOLOGY, EQUIPMENT_COUNT, POWER_ALLOCATION_KW, SPACE_ALLOCATION_M2,
    MONTHLY_FEE_EUR, ANNUAL_REVENUE_EUR, STATUS
)
SELECT 
    'INST-' || LPAD(ROW_NUMBER() OVER (ORDER BY s.SITE_ID), 7, '0') AS INSTALLATION_ID,
    s.SITE_ID,
    CASE MOD(ROW_NUMBER() OVER (ORDER BY s.SITE_ID), 4)
        WHEN 0 THEN 'OP-ORANGE'
        WHEN 1 THEN 'OP-SFR'
        WHEN 2 THEN 'OP-BOUYGUES'
        ELSE 'OP-FREE'
    END AS OPERATOR_ID,
    'CTR-' || LPAD(ROW_NUMBER() OVER (ORDER BY s.SITE_ID), 6, '0') AS CONTRACT_NUMBER,
    DATEADD(YEAR, -UNIFORM(1, 10, RANDOM()), CURRENT_DATE()) AS CONTRACT_START_DATE,
    DATEADD(YEAR, UNIFORM(3, 15, RANDOM()), CURRENT_DATE()) AS CONTRACT_END_DATE,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 80 THEN 'COLOCATION' ELSE 'FULL_SERVICE' END AS CONTRACT_TYPE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 40 THEN '4G'
        WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN '5G'
        ELSE '4G'
    END AS TECHNOLOGY,
    UNIFORM(3, 12, RANDOM()) AS EQUIPMENT_COUNT,
    UNIFORM(2, 15, RANDOM()) AS POWER_ALLOCATION_KW,
    UNIFORM(5, 30, RANDOM()) AS SPACE_ALLOCATION_M2,
    UNIFORM(2000, 8000, RANDOM()) AS MONTHLY_FEE_EUR,
    UNIFORM(24000, 96000, RANDOM()) AS ANNUAL_REVENUE_EUR,
    'ACTIVE' AS STATUS
FROM SITES s
CROSS JOIN (SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3) multiplier  -- Multiple operators per site
WHERE s.STATUS = 'ACTIVE' AND s.SITE_TYPE IN ('TOWER', 'ROOFTOP')
LIMIT 20000;

-- ============================================================================
-- EQUIPMENT (~80,000 pieces across all sites)
-- ============================================================================

INSERT INTO EQUIPMENT (
    EQUIPMENT_ID, EQUIPMENT_CODE, SITE_ID, TOWER_ID,
    EQUIPMENT_TYPE_ID, EQUIPMENT_CATEGORY, MANUFACTURER, MODEL, SERIAL_NUMBER,
    INSTALLATION_DATE, WARRANTY_END_DATE, EXPECTED_END_OF_LIFE,
    LIFECYCLE_STATUS, CONDITION_SCORE, FAILURE_RISK_SCORE,
    ORIGINAL_COST_EUR, CURRENT_BOOK_VALUE_EUR, REPLACEMENT_COST_EUR,
    POWER_CONSUMPTION_W, IS_CRITICAL, OWNER
)
SELECT 
    'EQP-' || LPAD(ROW_NUMBER() OVER (ORDER BY s.SITE_ID, et.EQUIPMENT_TYPE_ID), 7, '0') AS EQUIPMENT_ID,
    'EQP-' || et.EQUIPMENT_TYPE_CODE || '-' || LPAD(ROW_NUMBER() OVER (ORDER BY s.SITE_ID, et.EQUIPMENT_TYPE_ID), 5, '0') AS EQUIPMENT_CODE,
    s.SITE_ID,
    t.TOWER_ID,
    et.EQUIPMENT_TYPE_ID,
    et.CATEGORY AS EQUIPMENT_CATEGORY,
    et.MANUFACTURER,
    et.EQUIPMENT_TYPE_NAME || ' v' || UNIFORM(1, 5, RANDOM()) AS MODEL,
    'SN-' || LPAD(UNIFORM(100000, 999999, RANDOM()), 10, '0') AS SERIAL_NUMBER,
    DATEADD(YEAR, -UNIFORM(1, 15, RANDOM()), CURRENT_DATE()) AS INSTALLATION_DATE,
    DATEADD(YEAR, UNIFORM(1, 5, RANDOM()), CURRENT_DATE()) AS WARRANTY_END_DATE,
    DATEADD(YEAR, UNIFORM(3, 15, RANDOM()), CURRENT_DATE()) AS EXPECTED_END_OF_LIFE,
    CASE 
        WHEN UNIFORM(0, 100, RANDOM()) < 15 THEN 'NEW'
        WHEN UNIFORM(0, 100, RANDOM()) < 75 THEN 'OPERATIONAL'
        WHEN UNIFORM(0, 100, RANDOM()) < 95 THEN 'AGING'
        ELSE 'END_OF_LIFE'
    END AS LIFECYCLE_STATUS,
    UNIFORM(30, 100, RANDOM()) AS CONDITION_SCORE,
    UNIFORM(5, 80, RANDOM()) AS FAILURE_RISK_SCORE,
    et.AVERAGE_UNIT_COST_EUR AS ORIGINAL_COST_EUR,
    et.AVERAGE_UNIT_COST_EUR * UNIFORM(0.2, 0.8, RANDOM()) AS CURRENT_BOOK_VALUE_EUR,
    et.AVERAGE_UNIT_COST_EUR * 1.2 AS REPLACEMENT_COST_EUR,
    et.POWER_CONSUMPTION_W,
    et.IS_CRITICAL,
    CASE WHEN UNIFORM(0, 100, RANDOM()) < 70 THEN 'TDF' ELSE 'OPERATOR' END AS OWNER
FROM SITES s
LEFT JOIN TOWERS t ON s.SITE_ID = t.SITE_ID
CROSS JOIN TDF_DATA_PLATFORM.CORE.EQUIPMENT_TYPES et
WHERE s.STATUS = 'ACTIVE'
LIMIT 80000;

SELECT 'INFRASTRUCTURE DATA SEEDED' AS STATUS,
       (SELECT COUNT(*) FROM SITES) AS SITES_COUNT,
       (SELECT COUNT(*) FROM TOWERS) AS TOWERS_COUNT,
       (SELECT COUNT(*) FROM DATA_CENTERS) AS DC_COUNT,
       (SELECT COUNT(*) FROM CLIENT_INSTALLATIONS) AS INSTALLATIONS_COUNT,
       (SELECT COUNT(*) FROM EQUIPMENT) AS EQUIPMENT_COUNT;

